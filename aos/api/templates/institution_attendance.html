{% extends "dashboard.html" %}
{% from "components/atoms/Card.html" import card %}
{% from "components/molecules/DataCard.html" import data_card %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<header class="mb-10 flex items-center justify-between">
    <div>
        <h1 class="aos-h1 mb-2">Attendance Tracking</h1>
        <p class="aos-text-muted aos-text-sm">Digital Parish Office | Weekly Trends & Logs</p>
    </div>
    <div class="flex items-center gap-3">
        <a href="/institution/export/attendance?community_id={{ community_id }}"
            class="aos-btn aos-btn-ghost aos-size-md">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            <span class="aos-btn-text ml-2">Export Logs</span>
        </a>
    </div>
</header>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
    <!-- Trend Chart -->
    <div class="lg:col-span-2">
        {% call card(id="attendance-trends-card") %}
        <div class="flex items-center justify-between mb-4">
            <h3 class="aos-text-lg font-bold">Weekly Performance</h3>
            <span class="aos-text-xs aos-text-muted uppercase tracking-widest font-bold">Last 8 Weeks</span>
        </div>
        <div class="h-[250px] relative">
            <canvas id="attendanceChart"></canvas>
        </div>
        {% endcall %}
    </div>

    <!-- Quick Stats -->
    <div class="space-y-6">
        {{ data_card(label="This Week", value=trends[-1].count|string if trends else "0", unit="members",
        status="success") }}
        {{ data_card(label="Avg. Engagement", value="78%", unit="rate", status="info") }}
    </div>
</div>

<section class="aos-stack-md">
    <div class="flex items-center justify-between mb-6">
        <h2 class="aos-h2">Mark Attendance</h2>
        <div class="flex items-center gap-4">
            <input type="date" id="attendance-date" class="aos-input aos-size-sm" value="{{ now_date }}">
            <select id="service-type" class="aos-input aos-size-sm">
                <option value="Main Service">Main Service</option>
                <option value="Youth Service">Youth Service</option>
                <option value="Mid-week">Mid-week</option>
            </select>
        </div>
    </div>

    {% call card(padding="0", class="aos-overflow-hidden") %}
    <table class="aos-table">
        <thead>
            <tr>
                <th>Member Name</th>
                <th>Role</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for member in members %}
            <tr>
                <td class="aos-font-bold">{{ member.full_name }}</td>
                <td><span class="aos-badge aos-badge-ghost">{{ member.role_id }}</span></td>
                <td id="status-{{ member.id }}">
                    <span class="aos-text-muted aos-text-xs">Not Marked</span>
                </td>
                <td>
                    <button class="aos-btn aos-btn-primary aos-size-sm" hx-post="/institution/attendance"
                        hx-vals='js:{"member_id": "{{ member.id }}", "community_id": "{{ community_id }}", "service_type": document.getElementById("service-type").value, "operator_id": "{{ user.id }}"}'
                        hx-target="#status-{{ member.id }}" hx-swap="innerHTML">
                        <span class="aos-btn-text">Present</span>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endcall %}
</section>

<script id="trends-data" type="application/json">{{ trends | tojson if trends else '[]' }}</script>
<script>
    const ctx = document.getElementById('attendanceChart').getContext('2d');
    const attendanceTrendsData = JSON.parse(document.getElementById('trends-data').textContent);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: attendanceTrendsData.map(t => t.week),
            datasets: [{
                label: 'Member Attendance',
                data: attendanceTrendsData.map(t => t.count),
                borderColor: '#60a5fa',
                backgroundColor: 'rgba(96, 165, 250, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#60a5fa',
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 }, stepSize: 5 }
                }
            }
        }
    });
</script>

{% endblock %}