{% macro resource_widget() %}
<!-- Resource Status Widget -->
<div class="aos-glass rounded-2xl p-4 border border-slate-800/50">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest">System Resources</h3>
        <div id="power-profile-badge" class="aos-badge aos-badge-success text-[10px]">
            FULL POWER
        </div>
    </div>

    <!-- Battery Indicator -->
    <div id="battery-container" class="mb-4">
        <div class="flex items-center justify-between mb-2">
            <span class="text-xs text-slate-400 font-semibold">Battery</span>
            <span id="battery-percent" class="text-sm font-mono text-slate-200">100%</span>
        </div>
        <div class="w-full h-2 bg-slate-900 rounded-full overflow-hidden">
            <div id="battery-bar"
                class="h-full bg-gradient-to-r from-green-500 to-green-400 transition-all duration-500"
                style="width: 100%"></div>
        </div>
        <div class="flex items-center gap-2 mt-1">
            <svg id="battery-icon" class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                <path
                    d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z" />
            </svg>
            <span id="battery-status" class="text-[10px] text-slate-500 uppercase tracking-wider">Charging</span>
        </div>
    </div>

    <!-- Resource Meters -->
    <div class="space-y-3">
        <!-- CPU -->
        <div>
            <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-400">CPU</span>
                <span id="cpu-percent" class="text-xs font-mono text-slate-300">0%</span>
            </div>
            <div class="w-full h-1.5 bg-slate-900 rounded-full overflow-hidden">
                <div id="cpu-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Memory -->
        <div>
            <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-400">Memory</span>
                <span id="memory-percent" class="text-xs font-mono text-slate-300">0%</span>
            </div>
            <div class="w-full h-1.5 bg-slate-900 rounded-full overflow-hidden">
                <div id="memory-bar" class="h-full bg-purple-500 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Disk -->
        <div>
            <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-400">Disk</span>
                <span id="disk-percent" class="text-xs font-mono text-slate-300">0%</span>
            </div>
            <div class="w-full h-1.5 bg-slate-900 rounded-full overflow-hidden">
                <div id="disk-bar" class="h-full bg-amber-500 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Deferred Tasks Indicator -->
    <div id="deferred-tasks-container" class="mt-4 pt-4 border-t border-slate-800/30 hidden">
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="text-xs text-slate-400">
                <span id="deferred-count" class="font-bold text-amber-400">0</span> tasks deferred
            </span>
        </div>
    </div>
</div>

<script>
    // Resource widget real-time updates
    (function () {
        const eventSource = new EventSource('/stream');

        eventSource.addEventListener('resource.power_profile_changed', (e) => {
            const data = JSON.parse(e.data);
            updatePowerProfile(data.profile, data.battery_percent);
        });

        // Poll resource status every 30 seconds
        async function updateResourceStatus() {
            try {
                const response = await fetch('/sys/resource/status');
                if (!response.ok) return;

                const data = await response.json();

                // Update battery
                if (data.battery) {
                    updateBattery(data.battery);
                }

                // Update CPU
                document.getElementById('cpu-percent').textContent = data.cpu_percent.toFixed(1) + '%';
                document.getElementById('cpu-bar').style.width = data.cpu_percent + '%';

                // Update Memory
                document.getElementById('memory-percent').textContent = data.memory.percent.toFixed(1) + '%';
                document.getElementById('memory-bar').style.width = data.memory.percent + '%';

                // Update Disk
                document.getElementById('disk-percent').textContent = data.disk.percent.toFixed(1) + '%';
                document.getElementById('disk-bar').style.width = data.disk.percent + '%';

                // Update power profile
                updatePowerProfile(data.power_profile, data.battery ? data.battery.percent : 100);

                // Update deferred tasks
                if (data.scheduler.deferred > 0) {
                    document.getElementById('deferred-tasks-container').classList.remove('hidden');
                    document.getElementById('deferred-count').textContent = data.scheduler.deferred;
                } else {
                    document.getElementById('deferred-tasks-container').classList.add('hidden');
                }
            } catch (error) {
                console.error('Failed to update resource status:', error);
            }
        }

        function updateBattery(battery) {
            const percent = battery.percent;
            const status = battery.status;
            const plugged = battery.plugged;

            document.getElementById('battery-percent').textContent = percent.toFixed(0) + '%';
            document.getElementById('battery-bar').style.width = percent + '%';
            document.getElementById('battery-status').textContent = status;

            // Update battery bar color based on level
            const bar = document.getElementById('battery-bar');
            const icon = document.getElementById('battery-icon');

            if (percent > 50) {
                bar.className = 'h-full bg-gradient-to-r from-green-500 to-green-400 transition-all duration-500';
                icon.className = 'w-3 h-3 text-green-500';
            } else if (percent > 20) {
                bar.className = 'h-full bg-gradient-to-r from-amber-500 to-amber-400 transition-all duration-500';
                icon.className = 'w-3 h-3 text-amber-500';
            } else {
                bar.className = 'h-full bg-gradient-to-r from-red-500 to-red-400 transition-all duration-500';
                icon.className = 'w-3 h-3 text-red-500';
            }
        }

        function updatePowerProfile(profile, batteryPercent) {
            const badge = document.getElementById('power-profile-badge');
            badge.textContent = profile.replace('_', ' ');

            // Update badge color based on profile
            badge.className = 'aos-badge text-[10px]';
            if (profile === 'FULL_POWER') {
                badge.classList.add('aos-badge-success');
            } else if (profile === 'BALANCED') {
                badge.classList.add('aos-badge-info');
            } else if (profile === 'POWER_SAVER') {
                badge.classList.add('aos-badge-warning');
            } else if (profile === 'CRITICAL') {
                badge.classList.add('aos-badge-error');
            }
        }

        // Initial update
        updateResourceStatus();

        // Update every 30 seconds
        setInterval(updateResourceStatus, 30000);
    })();
</script>
{% endmacro %}