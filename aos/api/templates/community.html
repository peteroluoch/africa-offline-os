{% extends "dashboard.html" %}
{% from "components/atoms/EliteButton.html" import elite_button %}
{% from "components/atoms/Card.html" import card %}
{% from "components/molecules/DataCard.html" import data_card %}
{% from "components/molecules/Pagination.html" import pagination %}

{% block content %}
<header class="mb-10 flex items-center justify-between">
    <div>
        <h1 class="aos-h1 mb-2">Community-Pulse</h1>
        <p class="aos-text-muted aos-text-sm">trusted social distribution networks</p>
    </div>
    <div>
        <a href="/community/members" class="aos-btn aos-btn-ghost aos-size-md">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                </path>
            </svg>
            <span class="aos-btn-text ml-2">Member Directory</span>
        </a>
    </div>
</header>

<!-- Metrics Row -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    {{ data_card(label="Active Groups", value=total|string, status="info") }}
    {{ data_card(label="Pending", value=broadcast_stats.pending|string, unit="msgs", status="warning") }}
    {{ data_card(label="Delivered", value=broadcast_stats.sent|string, unit="msgs", status="success") }}
    {{ data_card(label="Failed", value=broadcast_stats.failed|string, unit="msgs", status="error") }}
</div>

<section class="aos-stack-md">
    <div class="flex items-center justify-between mb-6">
        <h2 class="aos-h2">Registered Groups</h2>
        <button class="aos-btn aos-btn-primary aos-size-md" hx-get="/community/register" hx-target="#modal-content"
            onclick="openModal()">
            <span class="aos-btn-text">Register Group</span>
        </button>
    </div>

    <!-- Filter Bar -->
    <div class="flex flex-wrap items-center gap-4 mb-6">
        <div class="flex-1 min-w-[240px]">
            <input type="text" name="search" placeholder="Search groups..." class="aos-input aos-size-md w-full"
                value="{{ search or '' }}" hx-get="/community" hx-trigger="keyup changed delay:500ms, search"
                hx-target="#groups-table-container" hx-push-url="true" hx-include="[name='type'], [name='trust']"
                hx-swap="outerHTML">
        </div>
        <div class="w-48">
            <select name="type" class="aos-input aos-size-md w-full" hx-get="/community"
                hx-target="#groups-table-container" hx-push-url="true" hx-include="[name='search'], [name='trust']"
                hx-swap="outerHTML">
                <option value="">All Types</option>
                {% for t in group_types %}
                <option value="{{ t }}" {% if t==selected_type %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="w-48">
            <select name="trust" class="aos-input aos-size-md w-full" hx-get="/community"
                hx-target="#groups-table-container" hx-push-url="true" hx-include="[name='search'], [name='type']"
                hx-swap="outerHTML">
                <option value="">All Trust</option>
                <option value="local" {% if selected_trust=='local' %}selected{% endif %}>Local</option>
                <option value="verified" {% if selected_trust=='verified' %}selected{% endif %}>Verified</option>
            </select>
        </div>
    </div>

    {% include "partials/community_groups_table.html" %}
</section>

<!-- Modal container for registration form -->
<div id="modal-container" class="aos-modal-overlay" onclick="if(event.target === this) closeModal()">
    <div class="aos-modal-content-wrapper w-full max-w-4xl px-4">
        {% call card(padding="0", glass=True, id="modal-content", class="aos-modal-content aos-stack-md w-full
        overflow-hidden") %}
        <!-- Loaded via HTMX -->
        <div class="aos-py-12 aos-text-center">
            <span class="aos-text-muted">Loading...</span>
        </div>
        {% endcall %}
    </div>
</div>

<!-- Delete modal removed - now using global premium modal -->

<script>
    // let deleteGroupId removed

    // Pagination handler
    function loadPage(pageNum) {
        // Collect current filter values
        const search = document.querySelector('input[name="search"]')?.value || '';
        const type = document.querySelector('select[name="type"]')?.value || '';
        const trust = document.querySelector('select[name="trust"]')?.value || '';

        htmx.ajax('GET', '/community', {
            values: { page: pageNum, search, type, trust },
            target: '#groups-table-container',
            swap: 'outerHTML'
        });

        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('page', pageNum);
        if (search) url.searchParams.set('search', search); else url.searchParams.delete('search');
        if (type) url.searchParams.set('type', type); else url.searchParams.delete('type');
        if (trust) url.searchParams.set('trust', trust); else url.searchParams.delete('trust');
        window.history.pushState({}, '', url);
    }

    function openModal() {
        // Show modal by changing display from none to flex
        document.getElementById('modal-container').style.display = 'flex';
    }

    function closeModal() {
        // Hide modal by changing display to none
        document.getElementById('modal-container').style.display = 'none';
    }

    // Confirm Delete logic moved to global HTMX confirm

    // Scroll to top on page load
    window.addEventListener('DOMContentLoaded', function () {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
</script>
{% endblock %}