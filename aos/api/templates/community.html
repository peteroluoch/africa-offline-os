{% extends "dashboard.html" %}
{% from "components/atoms/EliteButton.html" import elite_button %}
{% from "components/atoms/Card.html" import card %}
{% from "components/molecules/DataCard.html" import data_card %}
{% from "components/molecules/Pagination.html" import pagination %}

{% block content %}
<header class="mb-10 flex items-center justify-between">
    <div>
        <h1 class="aos-h1 mb-2">Community-Pulse</h1>
        <p class="aos-text-muted aos-text-sm">trusted social distribution networks</p>
    </div>
    <div>
        <a href="/community/members" class="aos-btn aos-btn-ghost aos-size-md">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                </path>
            </svg>
            <span class="aos-btn-text ml-2">Member Directory</span>
        </a>
    </div>
</header>

<!-- Metrics Row -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-8">
    {{ data_card(label="Active Groups", value=total|string, status="info") }}
    {{ data_card(label="Broadcasts", value=broadcasts_count|default(0)|string, unit="30d", status="success") }}
    {{ data_card(label="Inquiry Hits", value=inquiry_hits|default(0)|string, status="warning") }}
</div>

<section class="aos-stack-md">
    <div class="flex items-center justify-between mb-6">
        <h2 class="aos-h2">Registered Groups</h2>
        <button class="aos-btn aos-btn-primary aos-size-md" hx-get="/community/register" hx-target="#modal-content"
            onclick="openModal()">
            <span class="aos-btn-text">Register Group</span>
        </button>
    </div>

    <!-- Filter Bar -->
    <div class="flex flex-wrap items-center gap-4 mb-6">
        <div class="flex-1 min-w-[240px]">
            <input type="text" name="search" placeholder="Search groups..." class="aos-input aos-size-md w-full"
                value="{{ search or '' }}" hx-get="/community" hx-trigger="keyup changed delay:500ms, search"
                hx-target="#groups-table-container" hx-push-url="true" hx-include="[name='type'], [name='trust']"
                hx-swap="outerHTML">
        </div>
        <div class="w-48">
            <select name="type" class="aos-input aos-size-md w-full" hx-get="/community"
                hx-target="#groups-table-container" hx-push-url="true" hx-include="[name='search'], [name='trust']"
                hx-swap="outerHTML">
                <option value="">All Types</option>
                {% for t in group_types %}
                <option value="{{ t }}" {% if t==selected_type %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="w-48">
            <select name="trust" class="aos-input aos-size-md w-full" hx-get="/community"
                hx-target="#groups-table-container" hx-push-url="true" hx-include="[name='search'], [name='type']"
                hx-swap="outerHTML">
                <option value="">All Trust</option>
                <option value="local" {% if selected_trust=='local' %}selected{% endif %}>Local</option>
                <option value="verified" {% if selected_trust=='verified' %}selected{% endif %}>Verified</option>
            </select>
        </div>
    </div>

    {% include "partials/community_groups_table.html" %}
</section>

<!-- Modal container for registration form -->
<div id="modal-container" class="aos-modal-overlay" onclick="if(event.target === this) closeModal()">
    <div class="aos-modal-content-wrapper">
        {% call card(padding="6", glass=True, id="modal-content", class="aos-modal-content aos-stack-md") %}
        <!-- Loaded via HTMX -->
        {% endcall %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="aos-modal-overlay" onclick="if(event.target === this) closeDeleteModal()">
    {% call card(padding="6", glass=True, class="aos-modal-content aos-stack-md max-w-md") %}
    <div class="aos-stack-sm">
        <div class="flex items-center gap-3 mb-4">
            <div class="p-3 rounded-full bg-red-500/10">
                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                    </path>
                </svg>
            </div>
            <div>
                <h3 class="aos-h3 mb-1">Confirm Deletion</h3>
                <p class="aos-text-sm aos-text-muted">This action cannot be undone</p>
            </div>
        </div>

        <p class="aos-text-base mb-6" id="delete-message">
            Are you sure you want to deactivate this community group? This will retire all broadcasts but preserve audit
            data.
        </p>

        <div class="flex gap-3 justify-end">
            <button class="aos-btn aos-btn-ghost aos-size-md" onclick="closeDeleteModal()">
                <span class="aos-btn-text">Cancel</span>
            </button>
            <button class="aos-btn aos-btn-danger aos-size-md" id="confirm-delete-btn">
                <span class="aos-btn-text">Delete Group</span>
            </button>
        </div>
    </div>
    {% endcall %}
</div>

<script>
    let deleteGroupId = null;

    // Pagination handler
    function loadPage(pageNum) {
        // Collect current filter values
        const search = document.querySelector('input[name="search"]')?.value || '';
        const type = document.querySelector('select[name="type"]')?.value || '';
        const trust = document.querySelector('select[name="trust"]')?.value || '';

        htmx.ajax('GET', '/community', {
            values: { page: pageNum, search, type, trust },
            target: '#groups-table-container',
            swap: 'outerHTML'
        });

        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('page', pageNum);
        if (search) url.searchParams.set('search', search); else url.searchParams.delete('search');
        if (type) url.searchParams.set('type', type); else url.searchParams.delete('type');
        if (trust) url.searchParams.set('trust', trust); else url.searchParams.delete('trust');
        window.history.pushState({}, '', url);
    }

    function openModal() {
        // Show modal by changing display from none to flex
        document.getElementById('modal-container').style.display = 'flex';
    }

    function closeModal() {
        // Hide modal by changing display to none
        document.getElementById('modal-container').style.display = 'none';
    }

    function confirmDelete(groupId, groupName) {
        deleteGroupId = groupId;
        document.getElementById('delete-message').textContent =
            `Are you sure you want to deactivate "${groupName}"? This will retire all broadcasts but preserve audit data.`;
        // Show delete modal
        document.getElementById('delete-modal').style.display = 'flex';
    }

    function closeDeleteModal() {
        // Hide delete modal
        document.getElementById('delete-modal').style.display = 'none';
        deleteGroupId = null;
    }

    // Handle actual deletion
    document.getElementById('confirm-delete-btn').addEventListener('click', async function () {
        if (!deleteGroupId) return;

        try {
            const response = await fetch(`/community/${deleteGroupId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                // Remove the row from the table
                const row = document.querySelector(`button[onclick*="${deleteGroupId}"]`)?.closest('tr');
                if (row) {
                    row.style.transition = 'opacity 0.3s';
                    row.style.opacity = '0';
                    setTimeout(() => row.remove(), 300);
                }
                closeDeleteModal();

                // Reload page to update counts and scroll to top
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }
        } catch (error) {
            console.error('Delete failed:', error);
            alert('Failed to delete group. Please try again.');
        }
    });

    // Scroll to top on page load
    window.addEventListener('DOMContentLoaded', function () {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
</script>
{% endblock %}