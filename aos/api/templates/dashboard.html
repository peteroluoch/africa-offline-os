{% from "components/atoms/EliteButton.html" import elite_button %}
{% from "components/atoms/Badge.html" import badge %}
{% from "components/atoms/Card.html" import card %}
{% from "components/atoms/SearchBar.html" import search_bar %}
{% from "components/molecules/DataCard.html" import data_card %}
{% from "components/molecules/NodeStatus.html" import node_status %}
{% from "components/molecules/SidebarItem.html" import sidebar_item %}
{% from "components/molecules/ResourceWidget.html" import resource_widget %}
{% from "components/molecules/CollapsibleMenuGroup.html" import collapsible_menu_group %}
{% from "components/molecules/DependencyAlert.html" import dependency_alert %}
{% from "components/molecules/LiveKernelLog.html" import live_kernel_log %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-OS Kernel | Monitoring</title>

    <!-- A-OS Design System -->
    {% include 'partials/design_system.html' %}

    <script src="/static/js/htmx.min.js"></script>
    <script src="/static/js/htmx-sse.min.js"></script>

    <style>
        .mesh-bg {
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            z-index: -1;
            background:
                radial-gradient(circle at 70% 30%, var(--aos-surface-elevated) 0%, transparent 40%),
                radial-gradient(circle at 30% 70%, var(--aos-surface-base) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, var(--aos-primary-active) 0%, transparent 60%);
            filter: blur(80px);
            opacity: 0.3;
            animation: mesh 20s ease infinite;
        }

        @keyframes mesh {

            0%,
            100% {
                transform: translate(0, 0) scale(1)
            }

            33% {
                transform: translate(10%, -10%) scale(1.1)
            }

            66% {
                transform: translate(-10%, 10%) scale(0.95)
            }
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="min-h-screen flex">
    <div class="mesh-bg"></div>

    <!-- Sidebar -->
    <aside
        class="w-72 border-r border-[var(--aos-surface-border)] aos-glass p-6 flex flex-col hidden lg:flex relative z-10">
        <div class="mb-10 px-2 text-center">
            <h1 class="aos-text-display text-4xl font-extrabold tracking-tighter text-[var(--aos-primary-base)]">A-OS
            </h1>
            <p class="aos-text-muted text-[var(--aos-size-xs)] uppercase tracking-[0.3em] font-bold aos-text-mono mt-1">
                Kernel v0.1.0
        </div>

        <!-- Search Bar -->
        <div class="px-4 mb-4">
            {{ search_bar(placeholder="Search modules...") }}
        </div>

        <!-- Navigation Groups -->
        <nav class="flex-1 space-y-2 overflow-y-auto px-2">
            <!-- Monitoring Group - VIEWER and above -->
            {% if user.role in ['super_admin', 'admin', 'viewer'] %}
            {{ collapsible_menu_group(
            title="Monitoring",
            icon='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                </path>
            </svg>',
            group_id="monitoring",
            is_expanded=True,
            items=[
            {
            "text": "Real-time Stream",
            "href": "/dashboard",
            "active": request.url.path == "/dashboard",
            "icon": '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z">
                </path>
            </svg>'
            }
            ]
            ) }}
            {% endif %}

            <!-- Security & Access Group - SYSTEM_ADMIN and above only -->
            {% if user.role in ['super_admin', 'admin'] %}
            {{ collapsible_menu_group(
            title="Security & Access",
            icon='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                </path>
            </svg>',
            group_id="security",
            items=[
            {
            "text": "Operators",
            "href": "/operators",
            "active": request.url.path == "/operators",
            "icon": '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                </path>
            </svg>'
            },
            {
            "text": "Security Policy",
            "href": "/security",
            "active": request.url.path == "/security",
            "icon": '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                </path>
            </svg>'
            }
            ]
            ) }}
            {% endif %}

            <!-- Domain Modules Group - SYSTEM_ADMIN and above only -->
            {% if user.role in ['super_admin', 'admin'] %}
            {{ collapsible_menu_group(
            title="Domain Modules",
            icon='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                </path>
            </svg>',
            group_id="domains",
            is_expanded=False,
            items=[
            {
            "section": "Agri-Pulse",
            "text": "Management Hub",
            "href": "/agri",
            "active": request.url.path == "/agri",
            "icon": '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.168.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.168.477-4.5 1.253">
                </path>
            </svg>'
            },
            {
            "text": "Field Agent Portal",
            "href": "/agri/portal",
            "active": request.url.path == "/agri/portal",
            "icon": '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>'
            },
            {
            "section": "Fleet Link",
            "text": "Transport-Mobile",
            "href": "/transport",
            "active": request.url.path.startswith("/transport"),
            "icon": '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0">
                </path>
            </svg>'
            },
            {
            "section": "Community Link",
            "text": "Community-Pulse",
            "href": "/community/",
            "active": request.url.path.startswith("/community"),
            "icon": '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                </path>
            </svg>'
            }
            ]
            ) }}
            {% endif %}

            <!-- Administration Group - SYSTEM_ADMIN and above only -->
            {% if user.role in ['super_admin', 'admin'] %}
            {{ collapsible_menu_group(
            title="Administration",
            icon='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                </path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>',
            group_id="admin",
            is_expanded=False,
            items=[
            {
            "text": "Telegram Users",
            "href": "/dashboard/users",
            "active": request.url.path.startswith("/dashboard/users"),
            "icon": '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                </path>
            </svg>'
            },
            {
            "text": "Regional Dashboard",
            "href": "/regional/dashboard",
            "active": request.url.path.startswith("/regional"),
            "icon": '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                </path>
            </svg>'
            },
            {
            "text": "Mesh Nodes",
            "href": "/sys/mesh",
            "active": request.url.path == "/sys/mesh",
            "icon": '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9">
                </path>
            </svg>'
            },
            {
            "text": "UI Gallery",
            "href": "/sys/gallery",
            "active": request.url.path == "/sys/gallery",
            "icon": '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                </path>
            </svg>'
            }
            ]
            ) }}
            {% endif %}
        </nav>

        <!-- Resource Widget -->
        <div class="px-6 py-4">
            {{ resource_widget() }}
        </div>

        <!-- Footer -->
        <div class="mt-auto">
            {{ node_status(name="Kernel Health", status="success", status_text="NOMINAL") }}
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative z-10">
        <header class="h-20 border-b border-slate-800/50 aos-glass px-10 flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <h2 class="aos-text-display text-xl font-bold text-slate-200 tracking-tight">Event Monitor</h2>
                <div class="h-5 w-px bg-slate-800"></div>
                {{ badge(text="Sovereign-Bus-Connected", variant="success") }}
            </div>

            <div class="flex items-center space-x-6">
                <div class="text-right">
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-[0.2em] leading-none mb-1">Status
                    </p>
                    <p class="text-xs font-bold text-green-400 aos-text-mono">AUTHENTICATED</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="text-sm font-semibold text-slate-300 aos-text-mono">{{ user.username }}</span>
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-tr from-blue-600 to-indigo-600 border border-blue-400/30 flex items-center justify-center font-bold text-white shadow-lg shadow-blue-900/40">
                        {{ user.username[:2].upper() }}
                    </div>
                </div>

                <div class="h-5 w-px bg-slate-800 mx-2"></div>

                <a href="/auth/logout"
                    class="group flex items-center justify-center w-10 h-10 rounded-xl aos-bg-surface-elevated aos-border-subtle aos-text-secondary hover:aos-text-danger hover:aos-bg-danger-fade transition-all duration-200"
                    title="Logout">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                </a>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-10 space-y-10">
            {% block content %}
            <!-- Metrics Row -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                {{ data_card(
                label="Heartbeat",
                value=metrics.heartbeat.value,
                trend=metrics.heartbeat.latency_ms|string + "ms Latency",
                status=metrics.heartbeat.status
                ) }}
                {{ data_card(
                label="Throughput",
                value=metrics.throughput.value,
                unit=metrics.throughput.unit,
                trend="Optimized",
                status=metrics.throughput.status
                ) }}
                {{ data_card(
                label="Mesh Peers",
                value=metrics.mesh_peers.value,
                unit=metrics.mesh_peers.unit,
                trend="Sovereign-Link",
                status=metrics.mesh_peers.status
                ) }}
                {{ data_card(
                label="Queue Depth",
                value=metrics.queue_depth.value,
                trend="Synchronized",
                status=metrics.queue_depth.status
                ) }}
            </div>

            <!-- Dependency Update Alerts (Admin Only) -->
            {{ dependency_alert(dependency_updates) }}

            <!-- Live Kernel Log (Collapsible) -->
            {{ live_kernel_log() }}
            {% endblock %}

            <!-- Footer -->
            <footer class="mt-auto pt-8 pb-6 border-t border-slate-800/30">
                <div class="flex items-center justify-between text-xs text-slate-500">
                    <div class="flex items-center space-x-4">
                        <span class="aos-text-mono">Â© 2025 A-OS Kernel</span>
                        <span class="text-slate-700">|</span>
                        <a href="/privacy" class="hover:text-blue-400 transition-colors duration-200">Privacy Policy</a>
                        <span class="text-slate-700">|</span>
                        <a href="/terms" class="hover:text-blue-400 transition-colors duration-200">Terms &
                            Conditions</a>
                        <span class="text-slate-700">|</span>
                        <a href="/cookies" class="hover:text-blue-400 transition-colors duration-200">Cookie Policy</a>
                    </div>
                    <div class="text-slate-600 aos-text-mono">
                        Kernel v0.1.0 | Build 2025.01
                    </div>
                </div>
            </footer>
        </div>
    </main>

    <!-- Global Premium Confirmation Modal -->
    <div id="confirm-modal" class="aos-modal-overlay hidden" style="z-index: 1000;"
        onclick="if(event.target === this) cancelConfirm()">
        <div class="aos-modal-content-wrapper w-full max-w-md px-4">
            {% call card(padding="8", glass=True, class="aos-modal-content aos-stack-md") %}
            <div class="flex items-center gap-4 mb-4">
                <div class="p-3 rounded-full bg-red-500/10 text-red-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                        </path>
                    </svg>
                </div>
                <div>
                    <h3 class="aos-h3 mb-1">Confirm Action</h3>
                    <p class="aos-text-xs aos-text-muted uppercase tracking-widest">Security Clearance Required</p>
                </div>
            </div>

            <p id="confirm-modal-message" class="aos-text-base aos-text-secondary leading-relaxed mb-6"></p>

            <div class="flex gap-3 justify-end">
                <button class="aos-btn aos-btn-ghost aos-size-md" onclick="cancelConfirm()">
                    <span class="aos-btn-text">Cancel</span>
                </button>
                <button id="confirm-modal-button" class="aos-btn aos-btn-danger aos-size-md">
                    <span class="aos-btn-text">Confirm & Execute</span>
                </button>
            </div>
            {% endcall %}
        </div>
    </div>

    <!-- Navigation Search Script -->
    <script>
        let currentConfirmDetail = null;

        function cancelConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('confirm-modal').style.display = 'none';
            currentConfirmDetail = null;
        }

        document.getElementById('confirm-modal-button').addEventListener('click', function () {
            if (currentConfirmDetail) {
                currentConfirmDetail.issueRequest();
                cancelConfirm();
            }
        });

        // Premium Confirmation System
        window.addEventListener('htmx:confirm', function (evt) {
            // Handle both hx-confirm (standard) and data-aos-confirm (custom override)
            const question = evt.detail.question || evt.target.getAttribute('data-aos-confirm');

            if (question) {
                // STOP the native browser confirm() dialog dead in its tracks
                evt.preventDefault();

                currentConfirmDetail = evt.detail;
                const modal = document.getElementById('confirm-modal');
                const message = document.getElementById('confirm-modal-message');

                if (modal && message) {
                    message.textContent = question;
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                }
            }
        });

        // Fallback for non-HTMX custom confirmations
        document.body.addEventListener('click', function (e) {
            const target = e.target.closest('[data-aos-confirm]');
            if (target && !target.hasAttribute('hx-delete') && !target.hasAttribute('hx-post')) {
                const question = target.getAttribute('data-aos-confirm');
                // Handle manual trigger here if needed
            }
        });
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('nav-search');

            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const navItems = document.querySelectorAll('[data-nav-item]');

                    navItems.forEach(item => {
                        const searchText = item.getAttribute('data-search-text') || '';
                        item.style.display = searchText.includes(query) ? 'flex' : 'none';
                    });
                });

                document.addEventListener('keydown', (e) => {
                    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                        e.preventDefault();
                        searchInput.focus();
                    }
                });
            }
        });
    </script>
</body>

</html>