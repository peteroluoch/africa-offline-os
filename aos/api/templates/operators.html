{% extends "dashboard.html" %}

{% block title %}Operators Management | A-OS Kernel{% endblock %}

{% block content %}
<div class="aos-container aos-p-8">
    <div class="aos-page-header aos-mb-8">
        <h1 class="aos-h1">Operator Registry</h1>
        <p class="aos-text-muted">Manage system identities, hierarchical roles, and community assignments.</p>
    </div>

    <!-- Stats -->
    <div class="aos-grid aos-grid-cols-3 aos-gap-6 aos-mb-8">
        <div class="aos-glass aos-p-6">
            <span class="aos-text-muted aos-text-xs uppercase tracking-widest font-bold">Total Identities</span>
            <div class="aos-text-3xl font-bold aos-text-primary">{{ operators|length }}</div>
        </div>
        <div class="aos-glass aos-p-6">
            <span class="aos-text-muted aos-text-xs uppercase tracking-widest font-bold">Pending Approval</span>
            <div class="aos-text-3xl font-bold aos-text-warning">
                {% set pending = 0 %}
                {% for op in operators %}
                {% if op.role == 'operator' and not op.community_id %}
                {% set pending = pending + 1 %}
                {% endif %}
                {% endfor %}
                {{ pending }}
            </div>
        </div>
        <div class="aos-glass aos-p-6">
            <span class="aos-text-muted aos-text-xs uppercase tracking-widest font-bold">Active Organizations</span>
            <div class="aos-text-3xl font-bold aos-text-success">{{ available_communities|length }}</div>
        </div>
    </div>

    <!-- Operators Table -->
    <div class="aos-glass aos-rounded-2xl aos-overflow-hidden">
        <div class="aos-p-6 border-b border-slate-700/50 flex justify-between items-center bg-slate-800/20">
            <h2 class="aos-h3">System Operators</h2>
            <div class="aos-text-xs aos-text-muted">FAANG Security Standard: RBAC Active</div>
        </div>

        <table class="aos-table w-full">
            <thead>
                <tr class="aos-bg-surface-elevated">
                    <th class="aos-p-4 text-left aos-text-muted aos-text-xs uppercase">Username</th>
                    <th class="aos-p-4 text-left aos-text-muted aos-text-xs uppercase">Current Role</th>
                    <th class="aos-p-4 text-left aos-text-muted aos-text-xs uppercase">Assigned Community</th>
                    <th class="aos-p-4 text-left aos-text-muted aos-text-xs uppercase">Identity Created</th>
                    <th class="aos-p-4 text-right aos-text-muted aos-text-xs uppercase">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for op in operators %}
                <tr class="border-b border-slate-700/30 hover:bg-slate-700/10 transition-colors">
                    <td class="aos-p-4">
                        <div class="font-bold aos-text-primary">{{ op.username }}</div>
                        <div class="aos-text-xs aos-text-muted">{{ op.id[:8] }}...</div>
                    </td>
                    <td class="aos-p-4">
                        {% if op.role == 'root' %}
                        <span
                            class="px-2 py-1 rounded bg-red-500/20 text-red-400 border border-red-500/30 text-xs font-bold uppercase">Root</span>
                        {% elif op.role == 'super_admin' or op.role == 'admin' %}
                        <span
                            class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 border border-blue-500/30 text-xs font-bold uppercase">Admin</span>
                        {% elif op.role == 'community_admin' %}
                        <span
                            class="px-2 py-1 rounded bg-purple-500/20 text-purple-400 border border-purple-500/30 text-xs font-bold uppercase">Group
                            Lead</span>
                        {% else %}
                        <span
                            class="px-2 py-1 rounded bg-slate-500/20 text-slate-400 border border-slate-500/30 text-xs font-bold uppercase">Field
                            Agent</span>
                        {% endif %}
                    </td>
                    <td class="aos-p-4 aos-text-sm">
                        {% if op.community_name %}
                        <span class="aos-text-muted italic">{{ op.community_name }}</span>
                        {% else %}
                        <span class="text-orange-400/70 text-xs">Unassigned</span>
                        {% endif %}
                    </td>
                    <td class="aos-p-4 aos-text-muted aos-text-xs">
                        {{ op.created_at[:10] }}
                    </td>
                    <td class="aos-p-4 text-right">
                        {% if op.username != user.username and op.role != 'root' %}
                        <button
                            onclick="openManageModal('{{ op.id }}', '{{ op.username }}', '{{ op.role }}', '{{ op.community_id }}')"
                            class="aos-btn aos-btn-sm aos-btn-primary">
                            Manage
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Management Modal -->
<div id="manageModal"
    class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm hidden flex items-center justify-center z-50">
    <div class="aos-glass aos-p-8 aos-rounded-3xl w-full max-w-md shadow-2xl border border-white/10">
        <h2 class="aos-h2 aos-mb-2">Adjust Permissions</h2>
        <p class="aos-text-muted aos-mb-6 text-sm">Identity: <span id="modalUsername"
                class="aos-text-primary font-bold"></span></p>

        <form id="manageForm" action="" method="POST" class="space-y-6">
            <div>
                <label class="block aos-text-xs uppercase aos-text-muted font-bold aos-mb-2">Security Role</label>
                <select name="role_name" id="modalRole"
                    class="w-full aos-glass aos-p-3 aos-rounded-lg border border-white/10 text-white">
                    {% for role in available_roles %}
                    <option value="{{ role }}">{{ role|replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="communitySelectGroup">
                <label class="block aos-text-xs uppercase aos-text-muted font-bold aos-mb-2">Community
                    Assignment</label>
                <select name="community_id" id="modalCommunity"
                    class="w-full aos-glass aos-p-3 aos-rounded-lg border border-white/10 text-white">
                    <option value="">Global (No specific group)</option>
                    {% for comm in available_communities %}
                    <option value="{{ comm.id }}">{{ comm.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="aos-flex aos-gap-4 aos-mt-8">
                <button type="button" onclick="closeManageModal()" class="aos-btn aos-btn-ghost flex-1">Cancel</button>
                <button type="submit" class="aos-btn aos-btn-primary flex-1">Apply Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openManageModal(id, username, role, commId) {
        const modal = document.getElementById('manageModal');
        const form = document.getElementById('manageForm');
        document.getElementById('modalUsername').textContent = username;
        document.getElementById('modalRole').value = role;
        document.getElementById('modalCommunity').value = commId || '';

        form.action = `/operators/${id}/update-role`;
        modal.classList.remove('hidden');
    }

    function closeManageModal() {
        document.getElementById('manageModal').classList.add('hidden');
    }

    // Auto-hide community select for system admins
    document.getElementById('modalRole').addEventListener('change', function (e) {
        const commGroup = document.getElementById('communitySelectGroup');
        if (['root', 'admin', 'super_admin'].includes(e.target.value)) {
            commGroup.style.opacity = '0.5';
            commGroup.style.pointerEvents = 'none';
        } else {
            commGroup.style.opacity = '1';
            commGroup.style.pointerEvents = 'all';
        }
    });
</script>
{% endblock %}